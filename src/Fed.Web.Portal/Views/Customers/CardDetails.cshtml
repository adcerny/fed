
@using Fed.Web.Portal.Models.Customers

@model CardDetailsModel

@{
    Layout = "_Master";
}

<div id="CustomerView">

    <h1>Customer: @Model.Customer.CompanyName</h1>

    <nav>
        <a href="~/customers/@Model.Customer.Id">Overview</a>
        <a href="~/customers/@Model.Customer.Id/accountInfo">Account Info</a>
        <a href="~/customers/@Model.Customer.Id/paymentInfo">Payment Info</a>
    </nav>

    <div id="portalForm">
        <form action="~/" id="payment-form" method="post">
            <div class="halfWidth">
                <div>
                    <h2>Card Details</h2>
                    <p id="payment-error-message"></p>
                </div>
                <div class="formRow">
                    <label for="card-number">Card Holder Name</label>
                    <input type="text" placeholder="Jo Bloggs" id="cardholderName" name="cardholderName" class="braintree-hosted-field" />
                    <div class="field-error-message">Please enter a valid card holder name</div>
                </div>
                <div class="formRow">
                    <label for="card-number">Card Number</label>
                    <div id="card-number" class="braintree-hosted-field"></div>
                    <div class="field-error-message">Please enter a valid card number</div>
                </div>
                <div class="formRow">
                    <label for="expiration-date">Expiration Date</label>
                    <div id="expiration-date" class="braintree-hosted-field"></div>
                    <div class="field-error-message">Please enter a valid expiration ate</div>
                </div>
                <div class="formRow">
                    <label for="cvv">CVV</label>
                    <div id="cvv" class="braintree-hosted-field"></div>
                    <div class="field-error-message">Please enter a valid CVV</div>
                </div>
                <input type="submit" value="Add Card Details" disabled class="linkButton" />
                <input type="hidden" id="customerId" name="customerId" value="@Model.Customer.Id" />
                <input type="hidden" id="contactId" name="contactId" value="@Model.Contact.Id" />
                <input type="hidden" id="addressLine1" name="addressLine1" value="@Model.BillingAddress?.AddressLine1" />
                <input type="hidden" id="postcode" name="postCode" value="@Model.BillingAddress?.Postcode" />
            </div>
        </form>
        <div id="payment-success">
            <div>
                <h3>Payment details for @Model.Customer.CompanyName added successfully</h3>
                <a href="/customers/@Model.Customer.Id" class="linkButton">Back to customer details</a>
            </div>
        </div>
        <div id="payment-failure">
            <div>
                <h3 id="payment-message">There was a problem.</h3>
                <a href="#" class="linkButton" onClick="window.location.reload()">Try again</a>
            </div>
        </div>
    </div>

</div>
<script src="https://js.braintreegateway.com/web/3.44.0/js/client.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.44.0/js/hosted-fields.min.js"></script>
<script>
    var form = document.querySelector('#payment-form');
    var submit = document.querySelector('input[type="submit"]');

    var els = document.getElementsByClassName('formRow');

    [...document.querySelectorAll('.formRow')].forEach(function (item) {
        item.addEventListener('click', function () {
            removeErrors();
        });
    });

    window.onblur = function () {
        removeErrors();
    }

    function removeErrors() {
        for (var el of els) {
            el.classList.remove('invalid-field');
        }
    }

    braintree.client.create({
    authorization: '@Model.ClientToken'
    }, function (clientErr, clientInstance) {
    if (clientErr) {
        console.error(clientErr);
        return;
    }

    braintree.hostedFields.create({
        client: clientInstance,
        styles: {
        'input': 'braintree-input',
            'input.invalid': {
                'color': '#F95B5B',
                'font-weight' : 'bold'
            },
        'input.valid' : {
            'color': '#14b487',
            'font-weight': 'bold'
            },
        },
        fields: {
        number: {
            selector: '#card-number',
            placeholder: '4111 1111 1111 1111'
        },
        cvv: {
            selector: '#cvv',
            placeholder: '123'
        },
        expirationDate: {
            selector: '#expiration-date',
            placeholder: '10/2023'
        }
        }
    }, function (hostedFieldsErr, hostedFieldsInstance) {
        if (hostedFieldsErr) {
            console.error(hostedFieldsErr);
            return;
        }

        submit.removeAttribute('disabled');

        form.addEventListener('submit', function (event) {
        event.preventDefault();
            var cardholderName = form.elements["cardholderName"];
            hostedFieldsInstance.tokenize(function (tokenizeErr, payload) {
                if (tokenizeErr || !cardholderName.value) {
                    console.log(tokenizeErr);
                    if (!cardholderName.value)
                        cardholderName.parentNode.classList.add("invalid-field");
                    if(tokenizeErr.details)
                        for (var error in tokenizeErr.details.invalidFields) {
                            var field = tokenizeErr.details.invalidFields[error];
                            field.parentNode.classList.add("invalid-field");
                        }

                    return;
            }

            // If this was a real integration, this is where you would
            // send the nonce to your server.
            submit.disabled = true;
            submit.value = "Please wait..."
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "?contactId=" + form.elements["contactId"].value, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    form.style.display = "none";
                    if (xhr.status == 200)
                        document.getElementById("payment-success").style.display = "block";
                    else if (xhr.status == 400) {
                        document.getElementById("payment-message").innerHTML = "Card was declined. Message was: " + xhr.responseText;
                        document.getElementById("payment-failure").style.display = "block";
                    }
                    else
                        document.getElementById("payment-failure").style.display = "block";
                }
            }
            xhr.send(JSON.stringify({
                cardHolderName: form.elements["cardholderName"].value,
                paymentMethodNonce: payload.nonce,
                addressLine1: form.elements["addressLine1"].value,
                postCode: form.elements["postCode"].value,
                isPrimary: true
            }));
        });
        }, false);
    });
    });
</script>